@page "/"
@using Bookstore.Data
@inject BookService BookService

<h3>Bookstore Management</h3>

<!-- Toast container fixed at the top center.
     Displays feedback messages (success, error, warning, info) after user actions. -->
<div class="toast-container position-fixed top-0 start-50 translate-middle-x p-1">
    @if (!string.IsNullOrEmpty(message))
    {
        <div class="toast show align-items-center text-bg-@toastType border-0 mb-2">
            <div class="d-flex">
                <div class="toast-body">
                    @message
                </div>
                <!-- Close button to manually dismiss the toast -->
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        @onclick="() => message = null"></button>
            </div>
        </div>
    }
</div>

<!-- Search bar for filtering books by Title, Author, or ISBN -->
<div style="display:flex; gap:12px; margin-bottom:16px;">
    <input type="text" placeholder="Search by Title, Author, or ISBN..."
           @bind="searchTerm" @bind:event="oninput"
           @onkeyup="HandleEnterKey" class="form-control" />
    <button class="button" @onclick="ExecuteSearch">Search</button>
</div>

<!-- Conditional rendering based on book list state -->
@if (books is null)
{
    <p><em>Loading books...</em></p>
}
else if (!books.Any())
{
    <p><em>No books found.</em></p>
}
else
{
    <!-- Table displaying book details and actions -->
    <table class="table">
        <thead>
            <tr>
                <th>Title</th><th>Author</th><th>ISBN</th><th>Status</th><th>Actions</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var b in books)
        {
            <tr>
                <td>@b.Title</td>
                <td>@b.Author</td>
                <td>@b.ISBN</td>
                <td>
                    <!-- Status badge: green if available, yellow if borrowed -->
                    @if (b.IsAvailable)
                    {
                        <span class="badge bg-success fs-6">Available</span>
                    }
                    else
                    {
                        <span class="badge bg-warning text-dark fs-6">Borrowed by @b.BorrowerName</span>
                    }
                </td>
                <td>
                    <!-- Action buttons: Borrow if available, Return if borrowed -->
                    @if (b.IsAvailable)
                    {
                        <button class="btn btn-primary btn-sm fs-6" @onclick="() => OpenBorrowModal(b)">Borrow</button>
                    }
                    else
                    {
                        <button class="btn btn-success btn-sm fs-6" @onclick="() => ReturnBook(b.BookId)">Return</button>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
}

<!-- Borrow modal displayed when user clicks "Borrow" -->
@if (showBorrowModal)
{
    <div class="modal-backdrop"></div>
    <div class="modal">
        <div class="modal-card">
            <div class="modal-header"><strong>Borrow Book: @selectedBook?.Title</strong></div>
            <div class="modal-body">
                <label>Borrower name</label>
                <!-- Input for borrower name -->
                <input class="form-control border-dark" @bind="borrowerName" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseBorrowModal">Cancel</button>
                <!-- Confirm button disabled until borrower name is provided -->
                <button class="btn btn-modal-confirm" @onclick="BorrowBook" disabled="@string.IsNullOrWhiteSpace(borrowerName)">Confirm</button>
            </div>
        </div>
    </div>
}

@code {
    // Holds the list of books retrieved from the database
    private List<Book>? books;

    // Current search term entered by the user
    private string searchTerm = string.Empty;

    // Controls whether the borrow modal is visible
    private bool showBorrowModal = false;

    // The book currently selected for borrowing
    private Book? selectedBook;

    // Name of the borrower entered in the modal
    private string borrowerName = string.Empty;

    // Toast state variables
    private string? message;              // Message text
    private string toastType = "success"; // Toast style: success, danger, warning, info
    private System.Timers.Timer? toastTimer; // Timer to auto-hide toast

    // Load books when the component initializes
    protected override async Task OnInitializedAsync()
    {
        books = await BookService.GetBooksAsync();
    }

    // Handle Enter key press in the search box
    private async Task HandleEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await ExecuteSearch();
    }

    // Execute search using BookService
    private async Task ExecuteSearch()
    {
        books = await BookService.SearchAsync(searchTerm);
    }

    // Open borrow modal for a specific book
    private void OpenBorrowModal(Book book)
    {
        selectedBook = book;
        borrowerName = string.Empty;
        showBorrowModal = true;
    }

    // Close borrow modal and reset state
    private void CloseBorrowModal()
    {
        showBorrowModal = false;
        selectedBook = null;
    }

    // Borrow selected book
    private async Task BorrowBook()
    {
        if (selectedBook is null || string.IsNullOrWhiteSpace(borrowerName))
            return;

        try
        {
            await BookService.BorrowAsync(selectedBook.BookId, borrowerName);
            CloseBorrowModal();
            await ExecuteSearch();
            ShowToast("Book borrowed successfully!", "success");
        }
        catch (Exception ex)
        {
            ShowToast($"Error: {ex.Message}", "danger");
        }
    }

    // Return a borrowed book
    private async Task ReturnBook(int bookId)
    {
        try
        {
            await BookService.ReturnAsync(bookId);
            await ExecuteSearch();
            ShowToast("Book returned successfully!", "success");
        }
        catch (Exception ex)
        {
            ShowToast($"Error: {ex.Message}", "danger");
        }
    }

    // Display a toast message and auto-hide after 3 seconds
    private void ShowToast(string msg, string type)
    {
        message = msg;
        toastType = type;

        // Timer automatically hides the toast after 3 seconds
        toastTimer?.Dispose();
        toastTimer = new System.Timers.Timer(3000);
        toastTimer.Elapsed += (_, __) =>
        {
            message = null;
            InvokeAsync(StateHasChanged);
            toastTimer?.Dispose();
        };
        toastTimer.AutoReset = false;
        toastTimer.Start();
    }
}
