@page "/"
@using Bookstore.Data
@inject BookService BookService

<h3>Bookstore Management</h3>

<!-- Toast container centralizado no topo -->
<div class="toast-container position-fixed top-0 start-50 translate-middle-x p-1">
    @if (!string.IsNullOrEmpty(message))
    {
        <div class="toast show align-items-center text-bg-@toastType border-0 mb-2">
            <div class="d-flex">
                <div class="toast-body">
                    @message
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        @onclick="() => message = null"></button>
            </div>
        </div>
    }
</div>

<!-- Search bar -->
<div style="display:flex; gap:12px; margin-bottom:16px;">
    <input type="text" placeholder="Search by Title, Author, or ISBN..."
           @bind="searchTerm" @bind:event="oninput"
           @onkeyup="HandleEnterKey" class="form-control" />
    <button class="button" @onclick="ExecuteSearch">Search</button>
</div>

@if (books is null)
{
    <p><em>Loading books...</em></p>
}
else if (!books.Any())
{
    <p><em>No books found.</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Title</th><th>Author</th><th>ISBN</th><th>Status</th><th>Actions</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var b in books)
        {
            <tr>
                <td>@b.Title</td>
                <td>@b.Author</td>
                <td>@b.ISBN</td>
                <td>
                    @if (b.IsAvailable)
                    {
                        <span class="badge bg-success fs-6">Available</span>
                    }
                    else
                    {
                        <span class="badge bg-warning text-dark fs-6">Borrowed by @b.BorrowerName</span>
                    }
                </td>
                <td>
                    @if (b.IsAvailable)
                    {
                        <button class="btn btn-primary btn-sm fs-6" @onclick="() => OpenBorrowModal(b)">Borrow</button>
                    }
                    else
                    {
                        <button class="btn btn-success btn-sm fs-6" @onclick="() => ReturnBook(b.BookId)">Return</button>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@if (showBorrowModal)
{
    <div class="modal-backdrop"></div>
    <div class="modal">
        <div class="modal-card">
            <div class="modal-header"><strong>Borrow Book: @selectedBook?.Title</strong></div>
            <div class="modal-body">
                <label>Borrower name</label>
                <input class="form-control" @bind="borrowerName" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseBorrowModal">Cancel</button>
                <button class="btn btn-primary" @onclick="BorrowBook" disabled="@string.IsNullOrWhiteSpace(borrowerName)">Confirm</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Book>? books;
    private string searchTerm = string.Empty;
    private bool showBorrowModal = false;
    private Book? selectedBook;
    private string borrowerName = string.Empty;

    // Toast state
    private string? message;
    private string toastType = "success"; // success, danger, warning, info
    private System.Timers.Timer? toastTimer;

    protected override async Task OnInitializedAsync()
    {
        books = await BookService.GetBooksAsync();
    }

    private async Task HandleEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await ExecuteSearch();
    }

    private async Task ExecuteSearch()
    {
        books = await BookService.SearchAsync(searchTerm);
    }

    private void OpenBorrowModal(Book book)
    {
        selectedBook = book;
        borrowerName = string.Empty;
        showBorrowModal = true;
    }

    private void CloseBorrowModal()
    {
        showBorrowModal = false;
        selectedBook = null;
    }

    private async Task BorrowBook()
    {
        if (selectedBook is null || string.IsNullOrWhiteSpace(borrowerName))
            return;

        try
        {
            await BookService.BorrowAsync(selectedBook.BookId, borrowerName);
            CloseBorrowModal();
            await ExecuteSearch();
            ShowToast("Book borrowed successfully!", "success");
        }
        catch (Exception ex)
        {
            ShowToast($"Error: {ex.Message}", "danger");
        }
    }

    private async Task ReturnBook(int bookId)
    {
        try
        {
            await BookService.ReturnAsync(bookId);
            await ExecuteSearch();
            ShowToast("Book returned successfully!", "success");
        }
        catch (Exception ex)
        {
            ShowToast($"Error: {ex.Message}", "danger");
        }
    }

    private void ShowToast(string msg, string type)
    {
        message = msg;
        toastType = type;

        // Timer para esconder automaticamente após 3 segundos
        toastTimer?.Dispose();
        toastTimer = new System.Timers.Timer(3000);
        toastTimer.Elapsed += (_, __) =>
        {
            message = null;
            InvokeAsync(StateHasChanged);
            toastTimer?.Dispose();
        };
        toastTimer.AutoReset = false;
        toastTimer.Start();
    }
}
